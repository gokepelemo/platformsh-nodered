name: app

type: nodejs:16

disk: 2048

dependencies:
  nodejs:
    'npm': '*'

hooks:
  build: !include
    type: string
    path: hooks/ops/build.sh
  deploy: !include
    type: string
    path: hooks/ops/deploy.sh
  post_deploy: !include
    type: string
    path: hooks/ops/post_deploy.sh

web:
  # Add a web location for a static site in the public directory. Not necessary if the / path is served by node-red's http in node.
  locations:
    '/':
      root: 'public'
      allow: true
      scripts: false
      index: ['index.html']
      rules:
        '\.(jpe?g|png|gif|svgz?|css|js|map|ico|bmp|eot|woff2?|otf|ttf)$':
          allow: true
          expires: 30m

  commands:
    start: !include
      type: string
      path: ops/start.sh

mounts:
  # A writable mount for the node-red user directory.
  '/.node-red':
    source: local
    source_path: 'node-red'

  # A writable mount for static files that are generated by node-red and can be shared between workflows. 
  '/files':
    source: local
    source_path: 'files'

variables:
  env:
    'NODE_OPTIONS': '--max-old-space-size=512'

source:
  operations:
    auto-update:
      command: |
        curl -fsS https://raw.githubusercontent.com/platformsh/source-operations/main/setup.sh | { bash /dev/fd/3 sop-autoupdate; } 3<&0
    update-nodered:
      command: !include
        type: string
        path: ops/source/update.sh
    install-node:
      command: !include
        type: string
        path: ops/source/install-node.sh
    revert-commit:
      command: !include
        type: string
        path: ops/source/revert-commit.sh

